<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>md-explorer</title>
<script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11/highlight.min.js"></script>
<link id="hljs-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github-dark.min.css">
<style>
/* â”€â”€ Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg:#0f1117; --sidebar:#161b22; --border:#30363d; --text:#e6edf3;
  --muted:#8b949e; --accent:#58a6ff; --hover:#21262d; --active:#1f3a5f;
  --scroll:#30363d; --code-bg:#161b22; --code-clr:#f0883e; --shadow:rgba(0,0,0,.45);
  --mark:rgba(255,214,0,.35);
}
[data-theme="light"] {
  --bg:#fff; --sidebar:#f6f8fa; --border:#d0d7de; --text:#1f2328;
  --muted:#57606a; --accent:#0969da; --hover:#eaeef2; --active:#dbe4f0;
  --scroll:#d0d7de; --code-bg:#f6f8fa; --code-clr:#e36209; --shadow:rgba(0,0,0,.12);
  --mark:rgba(255,214,0,.55);
}

/* â”€â”€ Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}
body{display:flex;flex-direction:column;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--scroll);border-radius:3px}

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header{
  display:flex;align-items:center;gap:10px;padding:0 14px;
  background:var(--sidebar);border-bottom:1px solid var(--border);
  flex-shrink:0;height:46px;
}
.logo{font-size:15px;font-weight:700;color:var(--accent);white-space:nowrap}
.search-trigger{
  flex:1;max-width:340px;display:flex;align-items:center;gap:8px;
  padding:5px 11px;background:var(--bg);border:1px solid var(--border);
  border-radius:6px;cursor:pointer;font-size:13px;color:var(--muted);
  transition:border-color .15s;
}
.search-trigger:hover{border-color:var(--accent);color:var(--text)}
.search-trigger .kbd{
  margin-left:auto;font-size:11px;color:var(--muted);
  background:var(--hover);padding:1px 5px;border-radius:4px;border:1px solid var(--border);
}
.breadcrumb{font-size:11px;color:var(--muted);font-family:monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:280px}
.breadcrumb span{color:var(--accent)}
.hdr-btns{margin-left:auto;display:flex;gap:6px}
.btn-icon{
  padding:5px 8px;background:transparent;border:1px solid var(--border);
  border-radius:6px;color:var(--text);cursor:pointer;font-size:14px;
  transition:border-color .15s,background .15s;
}
.btn-icon:hover{border-color:var(--accent);background:var(--hover)}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.layout{display:flex;flex:1;overflow:hidden}

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar{
  width:260px;min-width:160px;max-width:420px;background:var(--sidebar);
  border-right:1px solid var(--border);flex-shrink:0;resize:horizontal;
  overflow:hidden;display:flex;flex-direction:column;
}
.sidebar-filter{padding:8px;border-bottom:1px solid var(--border);flex-shrink:0}
.sidebar-filter input{
  width:100%;padding:5px 10px;background:var(--bg);border:1px solid var(--border);
  border-radius:6px;color:var(--text);font-size:12px;outline:none;
}
.sidebar-filter input:focus{border-color:var(--accent)}
.tree{flex:1;overflow-y:auto;padding:4px 0}

/* â”€â”€ TOC Section (sidebar bottom) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toc-section{flex-shrink:0;border-top:1px solid var(--border)}
.toc-section.hidden{display:none}
.toc-section-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:7px 12px;cursor:pointer;user-select:none;
  font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);
}
.toc-section-header:hover{background:var(--hover)}
.toc-chevron{font-size:9px;transition:transform .2s;display:inline-block}
.toc-list{max-height:0;overflow:hidden;transition:max-height .25s ease}
.toc-list.open{max-height:400px;overflow-y:auto}

/* â”€â”€ Tree Items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tree-node{user-select:none}
.tree-item{
  display:flex;align-items:center;gap:5px;padding:3px 8px;cursor:pointer;
  font-size:12.5px;border-radius:4px;white-space:nowrap;overflow:hidden;
  transition:background .1s;
}
.tree-item:hover{background:var(--hover)}
.tree-item.active{background:var(--active);color:var(--accent)}
.tree-item .icon{flex-shrink:0}
.tree-item .name{overflow:hidden;text-overflow:ellipsis;flex:1}
.tree-item .chevron{flex-shrink:0;font-size:9px;color:var(--muted);transition:transform .15s;margin-right:2px}
.tree-item.open .chevron{transform:rotate(90deg)}
.tree-children{display:none}
.tree-children.open{display:block}

/* â”€â”€ Content Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.content{flex:1;overflow:hidden;display:flex;flex-direction:column;position:relative}
.content-toolbar{
  padding:7px 14px;border-bottom:1px solid var(--border);display:flex;
  align-items:center;gap:8px;flex-shrink:0;background:var(--sidebar);height:40px;
}
.content-toolbar .filename{color:var(--text);font-weight:600;font-family:monospace;font-size:13px}
.toolbar-btns{margin-left:auto;display:flex;gap:5px}
.tbtn{
  padding:3px 10px;background:var(--hover);border:1px solid var(--border);
  border-radius:5px;color:var(--text);cursor:pointer;font-size:12px;
  transition:border-color .15s;
}
.tbtn:hover{border-color:var(--accent)}
.tbtn.on{border-color:var(--accent);color:var(--accent);background:var(--active)}
.tbtn.copied{border-color:var(--accent);color:var(--accent)}
.content-body{flex:1;overflow:auto;padding:28px 36px}
.placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--muted);gap:10px}
.placeholder .big{font-size:48px}
.placeholder p{font-size:14px}
.loading{color:var(--muted);font-size:13px;padding:16px;text-align:center}

/* â”€â”€ Markdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.raw-view{font-family:'SF Mono','Fira Code',monospace;font-size:13px;line-height:1.6;white-space:pre-wrap;color:var(--text)}
.md-body{max-width:820px;line-height:1.75;color:var(--text)}
.md-body h1,.md-body h2,.md-body h3,.md-body h4{margin:1.4em 0 .5em;line-height:1.3;scroll-margin-top:100px}
.md-body h1{font-size:2em;border-bottom:1px solid var(--border);padding-bottom:.3em}
.md-body h2{font-size:1.5em;border-bottom:1px solid var(--border);padding-bottom:.2em}
.md-body h3{font-size:1.25em}
.md-body h4{font-size:1.05em}
.md-body p{margin:.75em 0}
.md-body a{color:var(--accent);text-decoration:none}
.md-body a:hover{text-decoration:underline}
.md-body code{background:var(--code-bg);padding:2px 6px;border-radius:4px;font-family:monospace;font-size:.87em;color:var(--code-clr)}
.md-body pre{background:var(--code-bg);border:1px solid var(--border);border-radius:8px;padding:16px;overflow-x:auto;margin:1em 0}
.md-body pre code{background:none;padding:0;color:inherit;font-size:.87em}
.md-body blockquote{border-left:4px solid var(--accent);padding:4px 16px;margin:1em 0;color:var(--muted)}
.md-body table{border-collapse:collapse;width:100%;margin:1em 0}
.md-body th,.md-body td{border:1px solid var(--border);padding:8px 12px}
.md-body th{background:var(--hover);font-weight:600}
.md-body tr:hover{background:var(--hover)}
.md-body ul,.md-body ol{padding-left:1.5em;margin:.5em 0}
.md-body li{margin:.25em 0}
.md-body hr{border:none;border-top:1px solid var(--border);margin:2em 0}
.md-body img{max-width:100%;border-radius:8px}
.md-body mark,mark{background:var(--mark);color:var(--text);border-radius:2px;padding:0 2px}

/* â”€â”€ TOC Links â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toc-link{
  display:block;font-size:12px;color:var(--muted);padding:4px 12px;
  text-decoration:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  transition:color .1s,background .1s;border-left:2px solid transparent;
}
.toc-link:hover{color:var(--text);background:var(--hover)}
.toc-link.active{color:var(--accent);border-left-color:var(--accent);background:var(--active)}

/* â”€â”€ Search Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.search-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;
  display:flex;align-items:flex-start;justify-content:center;padding-top:80px;
  backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:opacity .15s;
}
.search-overlay.open{opacity:1;pointer-events:all}
.search-modal{
  width:620px;max-width:90vw;max-height:72vh;background:var(--sidebar);
  border:1px solid var(--border);border-radius:12px;overflow:hidden;
  box-shadow:0 24px 64px rgba(0,0,0,.6);display:flex;flex-direction:column;
  transform:translateY(-8px);transition:transform .15s;
}
.search-overlay.open .search-modal{transform:translateY(0)}
.search-input-row{
  display:flex;align-items:center;gap:10px;padding:12px 16px;
  border-bottom:1px solid var(--border);
}
.search-input-row input{
  flex:1;background:none;border:none;outline:none;color:var(--text);font-size:15px;
}
.search-input-row input::placeholder{color:var(--muted)}
.esc-tag{
  font-size:11px;color:var(--muted);background:var(--hover);
  padding:2px 6px;border-radius:4px;border:1px solid var(--border);cursor:pointer;flex-shrink:0;
}
.search-results{flex:1;overflow-y:auto}
.s-empty,.s-loading{text-align:center;padding:32px;color:var(--muted);font-size:14px}
.s-file-group{border-bottom:1px solid var(--border)}
.s-file-name{
  padding:7px 16px;font-size:11px;font-weight:600;color:var(--muted);
  font-family:monospace;background:var(--bg);position:sticky;top:0;
}
.s-match{
  display:flex;align-items:baseline;gap:10px;padding:5px 16px;
  cursor:pointer;font-size:12px;transition:background .1s;
}
.s-match:hover{background:var(--hover)}
.s-lnum{color:var(--muted);font-family:monospace;flex-shrink:0;font-size:11px;min-width:28px;text-align:right}
.s-text{color:var(--text);font-family:monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.s-text mark{background:var(--mark);color:var(--text);border-radius:2px;padding:0 1px}
.s-footer{padding:7px 16px;font-size:11px;color:var(--muted);border-top:1px solid var(--border)}
</style>
</head>
<body>

<header>
  <div class="logo">ğŸ“ md-explorer</div>
  <div class="search-trigger" id="searchTrigger" title="Search file contents (âŒ˜K)">
    <span>ğŸ”</span><span>Search in files...</span>
    <span class="kbd">âŒ˜K</span>
  </div>
  <div class="breadcrumb" id="breadcrumb"></div>
  <div class="hdr-btns">
    <button class="btn-icon" id="themeBtn" title="Toggle theme">ğŸŒ™</button>
  </div>
</header>

<div class="layout">
  <div class="sidebar">
    <div class="sidebar-filter">
      <input type="text" id="fileFilter" placeholder="Filter files..." autocomplete="off">
    </div>
    <div class="tree" id="tree"></div>
    <div class="toc-section hidden" id="tocSection">
      <div class="toc-section-header" id="tocToggle">
        <span>ON THIS PAGE</span>
        <span class="toc-chevron">â–¶</span>
      </div>
      <div class="toc-list" id="tocList"></div>
    </div>
  </div>

  <div class="content">
    <div class="content-toolbar" id="toolbar" style="display:none">
      <span class="filename" id="filename"></span>
      <div class="toolbar-btns">
        <button class="tbtn" id="copyPathBtn" title="Copy file path (âŒ˜â‡§C)">Copy Path</button>
        <button class="tbtn" id="copyContentBtn" title="Copy file content">Copy Content</button>
        <button class="tbtn" id="rawBtn">Raw</button>
      </div>
    </div>
    <div class="content-body" id="contentBody">
      <div class="placeholder">
        <div class="big">ğŸ“„</div>
        <p>Select a file from the tree to view its content</p>
      </div>
    </div>
  </div>
</div>

<!-- Search Modal -->
<div class="search-overlay" id="searchOverlay">
  <div class="search-modal">
    <div class="search-input-row">
      <span style="color:var(--muted);font-size:16px">ğŸ”</span>
      <input type="text" id="searchInput" placeholder="Search in files..." autocomplete="off">
      <span class="esc-tag" id="escBtn">ESC</span>
    </div>
    <div class="search-results" id="searchResults">
      <div class="s-empty">Type to search across all markdown files</div>
    </div>
  </div>
</div>

<script>
// â”€â”€ Setup marked (v12 compatible) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
marked.use({ gfm: true, breaks: true });

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activeItem = null, rawMode = false, currentFile = null;
let filterQ = '', searchTimer = null, currentSearchQ = '';
const expandedDirs = new Set();

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const esc   = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const escRe = s => s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
const $     = id => document.getElementById(id);

const apiTree   = p => fetch('/api/tree?path='   + encodeURIComponent(p)).then(r => r.json());
const apiFile   = p => fetch('/api/file?path='   + encodeURIComponent(p)).then(r => r.json());
const apiSearch = q => fetch('/api/search?q='    + encodeURIComponent(q)).then(r => r.json());

// â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTheme(t) {
  document.documentElement.dataset.theme = t;
  $('themeBtn').textContent = t === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
  $('hljs-css').href = t === 'light'
    ? 'https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github.min.css'
    : 'https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github-dark.min.css';
  localStorage.setItem('md-theme', t);
}
$('themeBtn').onclick = () => setTheme(document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark');

// â”€â”€ Session Persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveExpandedDirs() {
  const arr = [...expandedDirs].slice(0, 200);
  localStorage.setItem('md-expanded', JSON.stringify(arr));
}

async function restoreSession() {
  try {
    const saved = JSON.parse(localStorage.getItem('md-expanded') || '[]');
    // Sort by depth: parents before children
    saved.sort((a, b) => a.split('/').length - b.split('/').length);
    for (const dirPath of saved) {
      const item = $('tree').querySelector(`.tree-item[data-dirpath="${CSS.escape(dirPath)}"]`);
      if (item && !item.classList.contains('open')) {
        item.click();
        await new Promise(r => setTimeout(r, 50));
      }
    }
  } catch (_) { /* corrupted data, skip */ }

  const lastFile = localStorage.getItem('md-last-file');
  if (lastFile) {
    try { await openFileByPath(lastFile); } catch (_) { /* file gone, skip */ }
  }
}

// â”€â”€ File Tree â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderTree(container, dirPath, level = 0) {
  container.innerHTML = '<div class="loading">Loadingâ€¦</div>';
  const data = await apiTree(dirPath);
  container.innerHTML = '';

  let entries = data.entries || [];
  if (filterQ && level === 0) entries = entries.filter(e => e.name.toLowerCase().includes(filterQ));
  if (!entries.length) { container.innerHTML = '<div class="loading">Empty</div>'; return; }

  entries.forEach(entry => {
    const node = document.createElement('div');
    node.className = 'tree-node';
    const item = document.createElement('div');
    item.className = 'tree-item';
    item.style.paddingLeft = (8 + level * 14) + 'px';

    const isMd = !entry.isDir && /\.(md|mdx|markdown)$/i.test(entry.name);
    const icon = entry.isDir ? 'ğŸ“‚' : isMd ? 'ğŸ“' : 'ğŸ“„';

    if (entry.isDir) {
      item.dataset.dirpath = entry.path;
      item.innerHTML = `<span class="chevron">â–¶</span><span class="icon">${icon}</span><span class="name">${esc(entry.name)}</span>`;
      const children = document.createElement('div');
      children.className = 'tree-children';
      let loaded = false;
      item.addEventListener('click', async () => {
        const isOpen = children.classList.contains('open');
        item.classList.toggle('open', !isOpen);
        children.classList.toggle('open', !isOpen);
        if (!isOpen && !loaded) { loaded = true; await renderTree(children, entry.path, level + 1); }
        if (!isOpen) expandedDirs.add(entry.path); else expandedDirs.delete(entry.path);
        saveExpandedDirs();
      });
      node.append(item, children);
    } else {
      item.innerHTML = `<span class="icon">${icon}</span><span class="name">${esc(entry.name)}</span>`;
      item.addEventListener('click', () => openFile(entry, item));
      node.appendChild(item);
    }
    container.appendChild(node);
  });
}

// â”€â”€ Open File â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openFile(entry, itemEl, highlight = null) {
  if (activeItem) activeItem.classList.remove('active');
  activeItem = itemEl;
  if (itemEl) itemEl.classList.add('active');

  $('toolbar').style.display = 'flex';
  $('filename').textContent = entry.name;
  $('breadcrumb').innerHTML = `<span>${esc(entry.path)}</span>`;
  $('contentBody').innerHTML = '<div class="loading">Loadingâ€¦</div>';

  currentFile = await apiFile(entry.path);
  localStorage.setItem('md-last-file', entry.path);
  renderContent(highlight);
}

async function openFileByPath(relPath, highlight = null) {
  closeSearch();
  await openFile({ path: relPath, name: relPath.split('/').pop() }, null, highlight);
}

// â”€â”€ Render Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderContent(highlight = null) {
  if (!currentFile) return;
  const body = $('contentBody');
  const isMd = /\.(md|mdx|markdown)$/i.test(currentFile.name);

  resetToc();

  if (rawMode || !isMd) {
    body.innerHTML = `<div class="raw-view">${esc(currentFile.content)}</div>`;
  } else {
    body.innerHTML = `<div class="md-body">${marked.parse(currentFile.content)}</div>`;
    body.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
    buildToc();
  }

  if (highlight) setTimeout(() => scrollToTerm(body, highlight), 80);
}

// â”€â”€ Scroll to Search Term â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scrollToTerm(container, term) {
  const termLow = term.toLowerCase();
  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
  let node;
  while ((node = walker.nextNode())) {
    if (node.textContent.toLowerCase().includes(termLow)) {
      const el = node.parentElement;
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      const prev = el.style.background;
      el.style.cssText += ';background:var(--mark);transition:background 1.8s';
      setTimeout(() => { el.style.background = prev; }, 2200);
      break;
    }
  }
}

// â”€â”€ Table of Contents â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildToc() {
  const body = $('contentBody');
  const headings = body.querySelectorAll('h1,h2,h3,h4');
  if (headings.length < 1) { $('tocSection').classList.add('hidden'); return; }

  // Assign stable IDs
  const used = {};
  headings.forEach(h => {
    let slug = h.textContent.trim().toLowerCase().replace(/[^\w\s-]/g,'').replace(/\s+/g,'-').replace(/-+/g,'-');
    if (used[slug] !== undefined) { used[slug]++; slug += '-' + used[slug]; } else { used[slug] = 0; }
    h.id = slug;
  });

  // Render TOC links
  $('tocList').innerHTML = Array.from(headings).map(h => {
    const lv = parseInt(h.tagName[1]);
    return `<a class="toc-link" href="#${h.id}" data-id="${h.id}" style="padding-left:${10 + (lv-1)*10}px">${esc(h.textContent.trim())}</a>`;
  }).join('');

  // Smooth-scroll on click (within scrollable div, not window)
  $('tocList').querySelectorAll('.toc-link').forEach(a => {
    a.addEventListener('click', e => {
      e.preventDefault();
      const target = body.querySelector('#' + CSS.escape(a.dataset.id));
      if (target) {
        const offset = target.getBoundingClientRect().top - body.getBoundingClientRect().top + body.scrollTop - 16;
        body.scrollTo({ top: offset, behavior: 'smooth' });
      }
    });
  });

  // Active heading tracking via IntersectionObserver
  if (window._tocObs) window._tocObs.disconnect();
  window._tocObs = new IntersectionObserver(entries => {
    entries.forEach(e => {
      const link = $('tocList').querySelector(`[data-id="${CSS.escape(e.target.id)}"]`);
      if (link) link.classList.toggle('active', e.isIntersecting);
    });
  }, { root: body, rootMargin: '-5% 0% -82% 0%', threshold: 0 });
  headings.forEach(h => window._tocObs.observe(h));

  // Show and auto-expand TOC section
  $('tocSection').classList.remove('hidden');
  $('tocList').classList.add('open');
  $('tocToggle').querySelector('.toc-chevron').style.transform = 'rotate(90deg)';
}

function resetToc() {
  if (window._tocObs) { window._tocObs.disconnect(); window._tocObs = null; }
  $('tocList').innerHTML = '';
  $('tocList').classList.remove('open');
  $('tocSection').classList.add('hidden');
  $('tocToggle').querySelector('.toc-chevron').style.transform = '';
}

// â”€â”€ TOC Section Toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTocSection() {
  const list = $('tocList');
  const isOpen = list.classList.contains('open');
  list.classList.toggle('open', !isOpen);
  $('tocToggle').querySelector('.toc-chevron').style.transform = isOpen ? '' : 'rotate(90deg)';
}

$('tocToggle').addEventListener('click', toggleTocSection);

// â”€â”€ Copy Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyWithFeedback(text, btn, label) {
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = label; btn.classList.remove('copied'); }, 1500);
  }).catch(() => {
    btn.textContent = 'Failed';
    setTimeout(() => { btn.textContent = label; }, 1500);
  });
}

$('copyPathBtn').addEventListener('click', () => {
  if (currentFile) copyWithFeedback(currentFile.path, $('copyPathBtn'), 'Copy Path');
});

$('copyContentBtn').addEventListener('click', () => {
  if (currentFile) copyWithFeedback(currentFile.content, $('copyContentBtn'), 'Copy Content');
});

// â”€â”€ Search Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSearch() {
  $('searchOverlay').classList.add('open');
  setTimeout(() => $('searchInput').focus(), 50);
}

function closeSearch() {
  $('searchOverlay').classList.remove('open');
  $('searchInput').value = '';
  currentSearchQ = '';
  $('searchResults').innerHTML = '<div class="s-empty">Type to search across all markdown files</div>';
}

async function doSearch(q) {
  currentSearchQ = q;
  $('searchResults').innerHTML = '<div class="s-loading">Searchingâ€¦</div>';
  try {
    const data = await apiSearch(q);
    if (q !== currentSearchQ) return;
    renderSearchResults(data.results || [], q);
  } catch (_) {
    if (q === currentSearchQ) $('searchResults').innerHTML = '<div class="s-empty">Search error</div>';
  }
}

function renderSearchResults(results, q) {
  if (!results.length) {
    $('searchResults').innerHTML = `<div class="s-empty">No results for "<strong>${esc(q)}</strong>"</div>`;
    return;
  }

  const qRe = new RegExp('(' + escRe(esc(q)) + ')', 'gi');
  const html = results.map(r => `
    <div class="s-file-group">
      <div class="s-file-name">ğŸ“ ${esc(r.relPath)}</div>
      ${r.matches.map(m => `
        <div class="s-match" data-path="${esc(r.relPath)}" data-q="${esc(q)}">
          <span class="s-lnum">${m.lineNum}</span>
          <span class="s-text">${esc(m.line).replace(qRe, '<mark>$1</mark>')}</span>
        </div>
      `).join('')}
    </div>`).join('');

  $('searchResults').innerHTML = html + `<div class="s-footer">${results.length} file${results.length !== 1 ? 's' : ''} matched</div>`;
  $('searchResults').querySelectorAll('.s-match').forEach(el =>
    el.addEventListener('click', () => openFileByPath(el.dataset.path, el.dataset.q))
  );
}

// â”€â”€ Event Wiring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('rawBtn').addEventListener('click', () => {
  rawMode = !rawMode;
  $('rawBtn').textContent = rawMode ? 'Rendered' : 'Raw';
  $('rawBtn').classList.toggle('on', rawMode);
  renderContent();
});

$('fileFilter').addEventListener('input', e => {
  filterQ = e.target.value.toLowerCase().trim();
  renderTree($('tree'), '/', 0);
});

$('searchTrigger').addEventListener('click', openSearch);
$('escBtn').addEventListener('click', closeSearch);
$('searchOverlay').addEventListener('click', e => { if (e.target === $('searchOverlay')) closeSearch(); });

$('searchInput').addEventListener('input', e => {
  const q = e.target.value.trim();
  clearTimeout(searchTimer);
  if (!q) { currentSearchQ = ''; $('searchResults').innerHTML = '<div class="s-empty">Type to search across all markdown files</div>'; return; }
  searchTimer = setTimeout(() => doSearch(q), 320);
});

document.addEventListener('keydown', e => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); openSearch(); }
  if (e.key === 'Escape' && $('searchOverlay').classList.contains('open')) closeSearch();
  if ((e.metaKey || e.ctrlKey) && e.key === '\\') { e.preventDefault(); if (!$('tocSection').classList.contains('hidden')) toggleTocSection(); }
  if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key === 'C') { e.preventDefault(); if (currentFile) copyWithFeedback(currentFile.path, $('copyPathBtn'), 'Copy Path'); }
});

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setTheme(localStorage.getItem('md-theme') || 'dark');
renderTree($('tree'), '/', 0).then(() => restoreSession());
</script>
</body>
</html>
